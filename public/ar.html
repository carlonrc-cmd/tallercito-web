<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tallercito.mx | Visor de Realidad Aumentada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        #cameraFeed { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #arCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .ui-overlay { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .interactive { pointer-events: auto; }
    </style>
</head>
<body>

    <video id="cameraFeed" autoplay playsinline></video>

    <canvas id="arCanvas"></canvas>

    <div class="ui-overlay p-6 text-white">
        <div class="flex justify-between items-start">
            <button onclick="window.location.href='index.html'" class="interactive bg-slate-900/80 p-3 rounded-xl border border-amber-500/50 flex items-center gap-2 backdrop-blur-sm">
                <span class="text-amber-500">←</span> <span class="text-xs font-bold uppercase tracking-tighter">Regresar</span>
            </button>
            <div class="text-right">
                <span class="bg-amber-500 text-slate-900 px-2 py-1 rounded text-[10px] font-black uppercase">Modo AR Activo</span>
            </div>
        </div>

        <div class="interactive bg-slate-900/90 p-4 rounded-2xl border-t-4 border-amber-500 backdrop-blur-md mb-4 shadow-2xl">
            <h3 class="font-black text-sm mb-1 italic">GUÍA DE ALINEACIÓN</h3>
            <p class="text-[10px] text-slate-300 leading-tight">
                1. Coloca el tablero frente a la cámara.<br>
                2. Alinea el borde superior izquierdo del dibujo con la esquina de tu madera real.<br>
                3. Verifica que no haya nudos en las zonas marcadas.
            </p>
            <div class="mt-3 flex gap-2">
                <button onclick="ajustarEscala(0.9)" class="bg-slate-700 px-3 py-1 rounded-lg text-xs font-bold">-</button>
                <button onclick="ajustarEscala(1.1)" class="bg-slate-700 px-3 py-1 rounded-lg text-xs font-bold">+</button>
                <span class="text-[10px] self-center opacity-50 ml-auto uppercase font-mono" id="zoomVal">Zoom: 100%</span>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('arCanvas');
        const ctx = canvas.getContext('2d');
        let zoomManual = 1.0;

        // 1. Encender la cámara trasera
        async function iniciarCamara() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", focusMode: "continuous" } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Error al acceder a la cámara: " + err);
            }
        }

        // 2. Dibujar el plano de corte sobre la imagen
        function dibujarProyeccion() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // Recuperar datos del LocalStorage guardados en index.html
            const datosStr = localStorage.getItem('ultimo_plan_corte');
            if (!datosStr) return;

            const datos = JSON.parse(datosStr);
            const escalaBase = canvas.width / datos.largoT;
            const escalaFinal = escalaBase * zoomManual;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Estilo de línea de vanguardia (ámbar brillante con dash)
            ctx.strokeStyle = "#f59e0b";
            ctx.setLineDash([8, 4]);
            ctx.lineWidth = 3;
            ctx.shadowBlur = 10;
            ctx.shadowColor = "#f59e0b";

            datos.piezas.forEach(p => {
                // Dibujar el rectángulo de cada pieza
                ctx.strokeRect(p.x * escalaFinal, p.y * escalaFinal, p.w * escalaFinal, p.h * escalaFinal);
                
                // Añadir medida si hay espacio
                if (p.w * escalaFinal > 40) {
                    ctx.fillStyle = "rgba(245, 158, 11, 0.8)";
                    ctx.font = "bold 10px Inter, sans-serif";
                    ctx.fillText(`${p.w}x${p.h}`, (p.x * escalaFinal) + 5, (p.y * escalaFinal) + 15);
                }
            });

            requestAnimationFrame(dibujarProyeccion);
        }

        function ajustarEscala(val) {
            zoomManual *= val;
            document.getElementById('zoomVal').innerText = `Zoom: ${Math.round(zoomManual * 100)}%`;
        }

        // Iniciar todo
        iniciarCamara();
        dibujarProyeccion();
    </script>
</body>
</html>